<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="WebCodecs对音视频进行编码解码" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="WebCodecs" /><meta property="og:description" content="WebCodecs" /><link rel="canonical" href="chenng.cn/posts/WebCodecs%E5%AF%B9%E9%9F%B3%E8%A7%86%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/" /><meta property="og:url" content="chenng.cn/posts/WebCodecs%E5%AF%B9%E9%9F%B3%E8%A7%86%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/" /><meta property="og:site_name" content="Chenng’s Home" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-19T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="WebCodecs对音视频进行编码解码" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-10-19T00:00:00+08:00","datePublished":"2020-10-19T00:00:00+08:00","description":"WebCodecs","headline":"WebCodecs对音视频进行编码解码","mainEntityOfPage":{"@type":"WebPage","@id":"chenng.cn/posts/WebCodecs%E5%AF%B9%E9%9F%B3%E8%A7%86%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/"},"url":"chenng.cn/posts/WebCodecs%E5%AF%B9%E9%9F%B3%E8%A7%86%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/"}</script><title>WebCodecs对音视频进行编码解码 | Chenng's Home</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chenng's Home"><meta name="application-name" content="Chenng's Home"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210506201457_0026033cb6769057453d0142751005ae.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Chenng's Home</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ringcrl" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ringcrl','foxmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-5" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>WebCodecs对音视频进行编码解码</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>WebCodecs对音视频进行编码解码</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> chenng </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 19, 2020, 12:00 AM +0800" prep="on" > Oct 19, 2020 <i class="unloaded">2020-10-19T00:00:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2323 words">12 min</span></div></div><div class="post-content"><h1 id="webcodecs">WebCodecs</h1><ul><li>草案：https://wicg.github.io/web-codecs/<li>Github：https://github.com/WICG/web-codecs</ul><p>允许 Web 应用程序对音频和视频进行编码和解码的 API</p><h1 id="在-chrome--86-的版本进行体验">在 Chrome &gt;= 86 的版本进行体验</h1><ul><li>Chrome地址栏输入：chrome://flags/#enable-experimental-web-platform-features，设置成 <code class="language-plaintext highlighter-rouge">Enabled</code><li>通过命令行启用 Chrome：<code class="language-plaintext highlighter-rouge">/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --enable-blink-features=WebCodecs</code></ul><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// 通过 VideoEncoder API 检查当前浏览器是否支持</span>
<span class="k">if </span><span class="p">(</span><span class="dl">'</span><span class="s1">VideoEncoder</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 支持 WebCodecs API</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="web-编解码器-api-出现的原因">Web 编解码器 API 出现的原因</h1><p>现在已经有很多 Web API 进行媒体操作： <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStream_Recording_API">Media Stream API</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStream_Recording_API">Media Recording API</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API">Media Source API</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API">WebRTC API</a>，但是没有提供一些底层 API 给到 Web 开发者进行帧操作或者对已经编码的视频进行解封装操作。</p><p>很多音视频编辑器为了解决这个问题，使用了 WebAssembly 把<a href="https://en.wikipedia.org/wiki/Video_codec">音视频编解码</a>带到了浏览器，但是有个问题是现在的浏览器很多已经在底层支持了音视频编解码，并且还进行了很多硬件加速的调优，如果使用 WebAssembly 重新打包这些能力，似乎浪费人力和计算机资源。</p><p>所以就诞生了 <a href="https://wicg.github.io/web-codecs/">WebCodecs API</a>，暴露媒体 API 来使用浏览器已经有的一些能力，例如：</p><ul><li>视频和音频解码<li>视频和音频编码<li>原始视频帧<li>图像解码器</ul><p>这时候一些 web 媒体开发项目例如视频编辑器、视频会议、视频流的操作就方便多了</p><p>项目进展查看：https://github.com/WICG/web-codecs</p><h1 id="webcodecs-处理流程">WebCodecs 处理流程</h1><p><code class="language-plaintext highlighter-rouge">frames</code> 是视频处理的核心，因此 WebCodecs 大多数类要么消耗 <code class="language-plaintext highlighter-rouge">frames</code> 要么生产 <code class="language-plaintext highlighter-rouge">frames</code>。Video encoders 把 <code class="language-plaintext highlighter-rouge">frames</code> 转换为 <code class="language-plaintext highlighter-rouge">encoded chunks</code>，Video Decoders 把 <code class="language-plaintext highlighter-rouge">encoded chunks</code> 转换为 <code class="language-plaintext highlighter-rouge">frames</code>。这一切都在非主线程异步处理，所以可以保证主线程速度。</p><p>当前，在 WebCodecs 中，在页面上显示 <code class="language-plaintext highlighter-rouge">frame</code> 的唯一方法是将其转换为 <a href="https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap">ImageBitmap</a> 并在 canvas 上绘制位图或将其转换为 <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLTexture">WebGLTexture</a></p><h1 id="webcodecs-实际应用">Webcodecs 实际应用</h1><h2 id="encoding">Encoding</h2><p>现在有两种方法把已经存在的图片转换为 <code class="language-plaintext highlighter-rouge">VideoFrame</code></p><ul><li>一种是通过 <a href="https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap">ImageBitmap</a> 创建 frame<li>第二种是通过 <code class="language-plaintext highlighter-rouge">VideoTrackReader</code> 设置方法来处理从 <code class="language-plaintext highlighter-rouge">[MediaStreamTrack](https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamTrack)</code> 产生的 frame，当需要从摄像机或屏幕捕获视频流时，这个 API 很有用</ul><h3 id="imagebitmap">ImageBitmap</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210429091535_d1c49c49839de8210cf326cc6d8ef22c.png" alt="01.png" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">cnv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">canvas</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">// draw something on the canvas</span>
<span class="p">...</span>
<span class="kd">let</span> <span class="nx">bitmap</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">createImageBitmap</span><span class="p">(</span><span class="nx">cnv</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">frameFromBitmap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoFrame</span><span class="p">(</span><span class="nx">bitmap</span><span class="p">,</span> <span class="p">{</span> <span class="na">timestamp</span><span class="p">:</span> <span class="mi">0</span> <span class="p">});</span>
</pre></table></code></div></div><p>第一种是直接从 ImageBitmap 创建 frame。只需调用 <code class="language-plaintext highlighter-rouge">new VideoFrame()</code> 构造函数并为其提供 bitmap 和展示时间戳</p><h3 id="videotrackreader">VideoTrackReader</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210429091550_382ee962dab29bef0dd8d5699e036c95.png" alt="02.png" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">framesFromStream</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nf">getUserMedia</span><span class="p">({</span> <span class="err">…</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">vtr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoTrackReader</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nf">getVideoTracks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nx">vtr</span><span class="p">.</span><span class="nf">start</span><span class="p">((</span><span class="nx">frame</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">framesFromStream</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
<span class="p">});</span>
</pre></table></code></div></div><p>使用 VideoEncoder 将 frame 编码为 EncodedVideoChunk 对象，VideoEncoder 需要两个对象：</p><ul><li>带有 <code class="language-plaintext highlighter-rouge">output</code> 和 <code class="language-plaintext highlighter-rouge">error</code> 两个方法的初始化对象，传递给 <code class="language-plaintext highlighter-rouge">VideoEncoder</code> 后无法修改<li>Encoder 配置对象，其中包含输出视频流的参数。可以稍后通过调用 <code class="language-plaintext highlighter-rouge">configure()</code> 来更改这些参数</ul><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">init</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">output</span><span class="p">:</span> <span class="nx">handleChunk</span><span class="p">,</span>
  <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">let</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">codec</span><span class="p">:</span> <span class="dl">'</span><span class="s1">vp8</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">width</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span>
  <span class="na">height</span><span class="p">:</span> <span class="mi">480</span><span class="p">,</span>
  <span class="na">bitrate</span><span class="p">:</span> <span class="mi">8</span><span class="nx">_000_000</span><span class="p">,</span> <span class="c1">// 8 Mbps</span>
  <span class="na">framerate</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<span class="p">};</span>

<span class="kd">let</span> <span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoEncoder</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
<span class="nx">encoder</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</pre></table></code></div></div><p>设置好 encoder 后，可以接受 frames 了，当开始从 media stream 接受 frames 的时候，传递给 <code class="language-plaintext highlighter-rouge">VideoTrackReader.start()</code> 的 callback 就会被执行，把 frame 传递给 encoder，需要定时检查 frame 防止过多的 frames 导致处理问题。注意：<code class="language-plaintext highlighter-rouge">encoder.configure()</code> 和 <code class="language-plaintext highlighter-rouge">encoder.encode()</code> 会立即返回，不会等待真正处理完成。如果处理完成 <code class="language-plaintext highlighter-rouge">output()</code>方法会被调用，入参是 <code class="language-plaintext highlighter-rouge">encoded chunk</code>。再注意：<code class="language-plaintext highlighter-rouge">encoer.encode()</code> 会消耗掉 frame，如果 frame 需要后面使用，需要调用 <code class="language-plaintext highlighter-rouge">clone</code> 来复制它。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">frameCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">pendingOutputs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">vtr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoTrackReader</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nf">getVideoTracks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]);</span>

<span class="nx">vtr</span><span class="p">.</span><span class="nf">start</span><span class="p">((</span><span class="nx">frame</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">pendingOutputs</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 有太多帧正在处理中，编码器承受不过来，不添加新的处理帧了</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">frameCounter</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">pendingOutputs</span><span class="o">++</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">insert_keyframe</span> <span class="o">=</span> <span class="nx">frameCounter</span> <span class="o">%</span> <span class="mi">150</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="p">{</span> <span class="na">keyFrame</span><span class="p">:</span> <span class="nx">insert_keyframe</span> <span class="p">});</span>
<span class="p">});</span>
</pre></table></code></div></div><p>最后就是完成 handleChunk 方法，通常，此功能是通过网络发送数据块或将它们封装到到媒体容器中</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">handleChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>  <span class="c1">// actual bytes of encoded data</span>
  <span class="kd">let</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>        <span class="c1">// media time in microseconds</span>
  <span class="kd">let</span> <span class="nx">is_key</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">key</span><span class="dl">'</span><span class="p">;</span>       <span class="c1">// can also be 'delta'</span>
  <span class="nx">pending_outputs</span><span class="o">--</span><span class="p">;</span>
  <span class="nf">fetch</span><span class="p">(</span><span class="s2">`/upload_chunk?timestamp=</span><span class="p">${</span><span class="nx">timestamp</span><span class="p">}</span><span class="s2">&amp;type=</span><span class="p">${</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/octet-stream</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">body</span><span class="p">:</span> <span class="nx">data</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><p>有时候需要确保所有 pending 的 encoding 请求完成，调用 <code class="language-plaintext highlighter-rouge">flush()</code></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">await</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">flush</span><span class="p">();</span>
</pre></table></code></div></div><h2 id="decoding">Decoding</h2><p>设置 <code class="language-plaintext highlighter-rouge">VideoDecoder</code> 和上面类似，需要传递 <code class="language-plaintext highlighter-rouge">init</code> 和 <code class="language-plaintext highlighter-rouge">config</code> 两个对象</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">init</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">output</span><span class="p">:</span> <span class="nx">handleFrame</span><span class="p">,</span>
  <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">codec</span><span class="p">:</span> <span class="dl">"</span><span class="s2">vp8</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">codedWidth</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span>
  <span class="na">codedHeight</span><span class="p">:</span> <span class="mi">480</span><span class="p">,</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoDecoder</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
<span class="nx">decoder</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</pre></table></code></div></div><p>设置好 <code class="language-plaintext highlighter-rouge">decoder</code> 之后就可以给它喂 <code class="language-plaintext highlighter-rouge">EncodedVideoChunk</code> 对象了，通过 <code class="language-plaintext highlighter-rouge">[BufferSouce](https://developer.mozilla.org/en-US/docs/Web/API/BufferSource)</code> 来创建 <code class="language-plaintext highlighter-rouge">chunk</code></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">downloadVideoChunksFromServer</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">);</span>
<span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">responses</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EncodedVideoChunk</span><span class="p">({</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="nx">responses</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">timestamp</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">responses</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">body</span><span class="p">),</span>
  <span class="p">});</span>
  <span class="nx">decoder</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">await</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">flush</span><span class="p">();</span>

</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210429091610_1495b150a15d1fcdc5becf9f90cbbdb9.png" alt="03.png" /></p><p>渲染 <code class="language-plaintext highlighter-rouge">decoded frame</code> 到页面上分为三步：</p><ul><li>把 <code class="language-plaintext highlighter-rouge">VideoFrame</code> 转换为 <code class="language-plaintext highlighter-rouge">[ImageBitmap](https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap)</code><li>等待合适的时机显示 frame<li>将 image 画到 canvas 上</ul><p>当一个 frame 不再需要的时候，调用 <code class="language-plaintext highlighter-rouge">destroy()</code> 在垃圾回收之前手动销毁他，这可以减少页面内存占用</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">cnv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">canvas_to_render</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">cnv</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">"</span><span class="s2">2d</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">alpha</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">readyFrames</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">timeBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">function</span> <span class="nf">handleFrame</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">readyFrames</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">underflow</span><span class="p">)</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">renderFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">delay</span><span class="p">(</span><span class="nx">time_ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">time_ms</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">calculateTimeTillNextFrame</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">timeBase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">timeBase</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">media_time</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">timeBase</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="nx">media_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">renderFrame</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">readyFrames</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nx">readyFrames</span><span class="p">.</span><span class="nf">shift</span><span class="p">();</span>
  <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">bitmap</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">frame</span><span class="p">.</span><span class="nf">createImageBitmap</span><span class="p">();</span>
  <span class="nx">frame</span><span class="p">.</span><span class="nf">destroy</span><span class="p">();</span>
  <span class="c1">// 根据帧的时间戳，计算在显示下一帧之前需要的实时等待时间</span>
  <span class="kd">const</span> <span class="nx">timeTillNextFrame</span> <span class="o">=</span> <span class="nf">calculateTimeTillNextFrame</span><span class="p">(</span><span class="nx">frame</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
  <span class="k">await</span> <span class="nf">delay</span><span class="p">(</span><span class="nx">timeTillNextFrame</span><span class="p">);</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nf">drawImage</span><span class="p">(</span><span class="nx">bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// 立即下一帧渲染</span>
  <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">renderFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="demo">Demo</h2><p>体验地址：https://ringcrl.github.io/static/webcodecs-demo/</p><p>如果打不开参考上面【在 Chrome &gt;= 86 的版本进行体验】</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>

<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;style&gt;</span>
    <span class="nt">canvas</span> <span class="p">{</span>
      <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
      <span class="nl">background</span><span class="p">:</span> <span class="no">gold</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">button</span> <span class="p">{</span>
      <span class="nl">background-color</span><span class="p">:</span> <span class="m">#555555</span><span class="p">;</span>
      <span class="nl">border</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
      <span class="nl">color</span><span class="p">:</span> <span class="no">white</span><span class="p">;</span>
      <span class="nl">padding</span><span class="p">:</span> <span class="m">15px</span> <span class="m">32px</span><span class="p">;</span>
      <span class="nl">width</span><span class="p">:</span> <span class="m">150px</span><span class="p">;</span>
      <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
      <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
      <span class="nl">font-size</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">"playPause()"</span><span class="nt">&gt;</span>Pause<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">"dst"</span> <span class="na">width=</span><span class="s">"640"</span> <span class="na">height=</span><span class="s">"480"</span><span class="nt">&gt;&lt;/canvas&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">style=</span><span class="s">"visibility: hidden;"</span> <span class="na">id=</span><span class="s">"src"</span> <span class="na">width=</span><span class="s">"640"</span> <span class="na">height=</span><span class="s">"480"</span><span class="nt">&gt;&lt;/canvas&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./main.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">codecString</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">vp8</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">keepGoing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kd">function</span> <span class="nf">playPause</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">keepGoing</span> <span class="o">=</span> <span class="o">!</span><span class="nx">keepGoing</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">btn</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">button</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">keepGoing</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">btn</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Pause</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">btn</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Play</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">delay</span><span class="p">(</span><span class="nx">time_ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">time_ms</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">startDrawing</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cnv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">cnv</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">"</span><span class="s2">2d</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">alpha</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>

  <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">white</span><span class="dl">"</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">width</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">cnv</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">cnv</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">cx</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">cy</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">drawOneFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">drawOneFrame</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">time</span> <span class="o">/</span> <span class="mi">5000</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">time</span> <span class="o">/</span> <span class="mi">7000</span><span class="p">));</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">save</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nf">translate</span><span class="p">(</span><span class="nx">cx</span><span class="p">,</span> <span class="nx">cy</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">rotate</span><span class="p">(</span><span class="nx">angle</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">scale</span><span class="p">);</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">30px Verdana</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">black</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">😊📹📷Hello WebCodecs 🎥🎞️😊</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">measureText</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">fillText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="o">-</span><span class="nx">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">restore</span><span class="p">();</span>
    <span class="nb">window</span><span class="p">.</span><span class="nf">requestAnimationFrame</span><span class="p">(</span><span class="nx">drawOneFrame</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nb">window</span><span class="p">.</span><span class="nf">requestAnimationFrame</span><span class="p">(</span><span class="nx">drawOneFrame</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">captureAndEncode</span><span class="p">(</span><span class="nx">processChunk</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cnv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">fps</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">pendingOutputs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">frameCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">cnv</span><span class="p">.</span><span class="nf">captureStream</span><span class="p">(</span><span class="nx">fps</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">vtr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoTrackReader</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nf">getVideoTracks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="kd">const</span> <span class="nx">init</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">output</span><span class="p">:</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">pendingOutputs</span><span class="o">--</span><span class="p">;</span>
      <span class="nf">processChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
      <span class="nx">vtr</span><span class="p">.</span><span class="nf">stop</span><span class="p">();</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">codec</span><span class="p">:</span> <span class="nx">codecString</span><span class="p">,</span>
    <span class="na">width</span><span class="p">:</span> <span class="nx">cnv</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
    <span class="na">height</span><span class="p">:</span> <span class="nx">cnv</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
    <span class="na">bitrate</span><span class="p">:</span> <span class="mi">10</span><span class="nx">e6</span><span class="p">,</span>
    <span class="na">framerate</span><span class="p">:</span> <span class="nx">fps</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoEncoder</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
  <span class="nx">encoder</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>

  <span class="nx">vtr</span><span class="p">.</span><span class="nf">start</span><span class="p">((</span><span class="nx">frame</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">keepGoing</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">pendingOutputs</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Too many frames in flight, encoder is overwhelmed</span>
      <span class="c1">// let's drop this frame.</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">frameCounter</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">pendingOutputs</span><span class="o">++</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">insert_keyframe</span> <span class="o">=</span> <span class="nx">frameCounter</span> <span class="o">%</span> <span class="mi">150</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="p">{</span> <span class="na">keyFrame</span><span class="p">:</span> <span class="nx">insert_keyframe</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">frameToBitmapInTime</span><span class="p">(</span><span class="nx">frame</span><span class="p">,</span> <span class="nx">timeout_ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="na">colorSpaceConversion</span><span class="p">:</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span> <span class="p">};</span>
  <span class="kd">const</span> <span class="nx">convertPromise</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nf">createImageBitmap</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">timeout_ms</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">convertPromise</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">all</span><span class="p">([</span><span class="nx">convertPromise</span><span class="p">,</span> <span class="nf">delay</span><span class="p">(</span><span class="nx">timeout_ms</span><span class="p">)]);</span>
  <span class="k">return</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">startDecodingAndRendering</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">cnv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">dst</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">cnv</span><span class="p">.</span><span class="nf">getContext</span><span class="p">(</span><span class="dl">"</span><span class="s2">2d</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">alpha</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">readyFrames</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">let</span> <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">timeBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nf">calculateTimeTillNextFrame</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">timeBase</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">timeBase</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">mediaTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">timeBase</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="nx">mediaTime</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="kd">function</span> <span class="nf">renderFrame</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">readyFrames</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nx">readyFrames</span><span class="p">.</span><span class="nf">shift</span><span class="p">();</span>
    <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">bitmap</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">frame</span><span class="p">.</span><span class="nf">createImageBitmap</span><span class="p">();</span>
    <span class="c1">// 根据帧的时间戳，计算在显示下一帧之前需要的实时等待时间</span>
    <span class="kd">const</span> <span class="nx">timeTillNextFrame</span> <span class="o">=</span> <span class="nf">calculateTimeTillNextFrame</span><span class="p">(</span><span class="nx">frame</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
    <span class="k">await</span> <span class="nf">delay</span><span class="p">(</span><span class="nx">timeTillNextFrame</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">drawImage</span><span class="p">(</span><span class="nx">bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// 立即下一帧渲染</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">renderFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">frame</span><span class="p">.</span><span class="nf">destroy</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">handleFrame</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">readyFrames</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">underflow</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">underflow</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">renderFrame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">init</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">output</span><span class="p">:</span> <span class="nx">handleFrame</span><span class="p">,</span>
    <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">codec</span><span class="p">:</span> <span class="nx">codecString</span><span class="p">,</span>
    <span class="na">codedWidth</span><span class="p">:</span> <span class="nx">cnv</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
    <span class="na">codedHeight</span><span class="p">:</span> <span class="nx">cnv</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VideoDecoder</span><span class="p">(</span><span class="nx">init</span><span class="p">);</span>
  <span class="nx">decoder</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">decoder</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="dl">"</span><span class="s2">VideoEncoder</span><span class="dl">"</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;h1&gt;WebCodecs API is not supported.&lt;/h1&gt;</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nf">startDrawing</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="nf">startDecodingAndRendering</span><span class="p">();</span>
  <span class="nf">captureAndEncode</span><span class="p">((</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">decoder</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">main</span><span class="p">;</span>
</pre></table></code></div></div><h1 id="参考地址">参考地址</h1><p><a href="https://web.dev/webcodecs/">Video processing with WebCodecs</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/2020/" class="post-tag no-text-decoration" >2020</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/2018/">2018</a> <a class="post-tag" href="/tags/2017/">2017</a> <a class="post-tag" href="/tags/2019/">2019</a> <a class="post-tag" href="/tags/2020/">2020</a> <a class="post-tag" href="/tags/2021/">2021</a> <a class="post-tag" href="/tags/2016/">2016</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Telegram+rssbot%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF%E6%B5%81%E6%9C%8D%E5%8A%A1/"><div class="card-body"> <span class="timeago small" > Apr 12, 2020 <i class="unloaded">2020-04-12T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Telegram+rssbot搭建个人信息流服务</h3><div class="text-muted small"><p> 【即刻】走丢了很久，怀念她。想有一个渠道可以收敛日常生活中的所有通知，发现 Telegram 机器人配合 RSS 就很好的兼顾了阅读体验以及拓展支持，打开机器人对话框就能呈现一个完美的 Timeline。 方案：Telegram + 谷歌云 + flowerss-bot + RSSHub Telegram 机器人申请 在 Telegram 搜索 @BotFather，发送 /new...</p></div></div></a></div><div class="card"> <a href="/posts/%E9%80%9A%E8%BF%87babel-plugin%E6%A0%A1%E9%AA%8C%E5%B0%81%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84vue%E7%BB%84%E4%BB%B6/"><div class="card-body"> <span class="timeago small" > May 10, 2020 <i class="unloaded">2020-05-10T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>通过babel-plugin校验封装第三方提供的vue组件</h3><div class="text-muted small"><p> 之前就了解过 babel AST 相关的知识，刚好一个业务需求需要校验与修改第三方提供的 vue 组件，用 babel-plugin 来做这件事再合适不过了。 需求背景 三方提供互动的 vue 组件，如：https://m.v.qq.com/txi/dev 三方只编写基本的样式逻辑，最后需要在 vue 组件中注入默认 props、注入 mixins 提供与引擎通信的能力、并将 ...</p></div></div></a></div><div class="card"> <a href="/posts/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E8%A7%86%E9%A2%91%E6%AF%94%E5%AF%B9%E6%96%B9%E6%A1%88/"><div class="card-body"> <span class="timeago small" > May 6, 2021 <i class="unloaded">2021-05-06T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>canvas像素对比测试用例</h3><div class="text-muted small"><p> 最近在做服务端 canvas-webgl 渲染，探索下怎么通过自动化的方案来保证渲染效果。 探索背景 网络上对 Canvas 的渲染测试用例方案归纳有三种： 方案一：Node 记录 Canvas 的 API 操作记录，验证执行，例如：jest-mock-canvas 方案二：真实浏览器渲染比对，例如 cypress 方案三：学习 Three.js 的 e2e 测试用例，使...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E9%80%9A%E8%BF%87babel-plugin%E6%A0%A1%E9%AA%8C%E5%B0%81%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84vue%E7%BB%84%E4%BB%B6/" class="btn btn-outline-primary" prompt="Older"><p>通过babel-plugin校验封装第三方提供的vue组件</p></a> <a href="/posts/PS-AE-Sketch/" class="btn btn-outline-primary" prompt="Newer"><p>PS-AE-Sketch</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/ringcrl">chenng</a>.<p class="mb-0"> <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"> 粤ICP备18131461号 </a></p></p></div><div class="footer-right"></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/2018/">2018</a> <a class="post-tag" href="/tags/2017/">2017</a> <a class="post-tag" href="/tags/2019/">2019</a> <a class="post-tag" href="/tags/2020/">2020</a> <a class="post-tag" href="/tags/2021/">2021</a> <a class="post-tag" href="/tags/2016/">2016</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="chenng.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
