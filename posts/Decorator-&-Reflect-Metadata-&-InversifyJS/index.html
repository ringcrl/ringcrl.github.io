<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Decorator &amp; Reflect Metadata &amp; InversifyJS" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="InversifyJS 比 SOLID（面向对象设计)中的 D（依赖反转）好在哪里？ 四种 Decorator Reflect Metadata InversifyJS" /><meta property="og:description" content="InversifyJS 比 SOLID（面向对象设计)中的 D（依赖反转）好在哪里？ 四种 Decorator Reflect Metadata InversifyJS" /><link rel="canonical" href="chenng.cn/posts/Decorator-&-Reflect-Metadata-&-InversifyJS/" /><meta property="og:url" content="chenng.cn/posts/Decorator-&-Reflect-Metadata-&-InversifyJS/" /><meta property="og:site_name" content="Chenng’s Home" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-01-11T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Decorator &amp; Reflect Metadata &amp; InversifyJS" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-01-11T00:00:00+08:00","datePublished":"2019-01-11T00:00:00+08:00","description":"InversifyJS 比 SOLID（面向对象设计)中的 D（依赖反转）好在哪里？ 四种 Decorator Reflect Metadata InversifyJS","headline":"Decorator &amp; Reflect Metadata &amp; InversifyJS","mainEntityOfPage":{"@type":"WebPage","@id":"chenng.cn/posts/Decorator-&-Reflect-Metadata-&-InversifyJS/"},"url":"chenng.cn/posts/Decorator-&-Reflect-Metadata-&-InversifyJS/"}</script><title>Decorator & Reflect Metadata & InversifyJS | Chenng's Home</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chenng's Home"><meta name="application-name" content="Chenng's Home"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210506201457_0026033cb6769057453d0142751005ae.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Chenng's Home</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ringcrl" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ringcrl','foxmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-5" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Decorator & Reflect Metadata & InversifyJS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Decorator & Reflect Metadata & InversifyJS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> chenng </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jan 11, 2019, 12:00 AM +0800" prep="on" > Jan 11, 2019 <i class="unloaded">2019-01-11T00:00:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6019 words">33 min</span></div></div><div class="post-content"><ul><li>InversifyJS 比 SOLID（面向对象设计)中的 D（依赖反转）好在哪里？<li>四种 Decorator<li>Reflect Metadata<li>InversifyJS</ul><h1 id="solid-d-vs-inversifyjs">SOLID-D VS InversifyJS</h1><h2 id="solid-d">SOLID-D</h2><ul><li>高层模块不应该依赖于低层模块，他们都应该依赖于抽象接口<li>抽象接口应该脱离具体实现，具体实现应该依赖于抽象接口</ul><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="c1">// 反例</span>
<span class="kd">class</span> <span class="nc">InventoryTracker</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="nx">items</span><span class="p">;</span>

    <span class="c1">// 依赖了一个具体实现</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requester</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InventoryRequester</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nf">requestItems</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">requester</span><span class="p">.</span><span class="nf">requestItem</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">InventoryRequester</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">REQ_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">HTTP</span><span class="dl">"</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="nf">requestItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">inventoryTracker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InventoryTracker</span><span class="p">([</span><span class="dl">"</span><span class="s2">apples</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">bananas</span><span class="dl">"</span><span class="p">]);</span>
<span class="nx">inventoryTracker</span><span class="p">.</span><span class="nf">requestItems</span><span class="p">();</span>

<span class="c1">// 正例</span>
<span class="kd">class</span> <span class="nc">InventoryTracker</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="nx">requester</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="nx">items</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requester</span> <span class="o">=</span> <span class="nx">requester</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nf">requestItems</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">requester</span><span class="p">.</span><span class="nf">requestItem</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">InventoryRequesterV1</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">REQ_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">HTTP</span><span class="dl">"</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="nf">requestItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">InventoryRequesterV2</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">REQ_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">WS</span><span class="dl">"</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="nf">requestItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 依赖外置，通过参数注入依赖</span>
<span class="c1">// 我们可以轻松替换依赖项</span>
<span class="kd">let</span> <span class="nx">inventoryTracker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InventoryTracker</span><span class="p">(</span>
  <span class="p">[</span><span class="dl">"</span><span class="s2">apples</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">bananas</span><span class="dl">"</span><span class="p">],</span>
  <span class="k">new</span> <span class="nc">InventoryRequesterV2</span><span class="p">()</span>
<span class="p">);</span>
<span class="nx">inventoryTracker</span><span class="p">.</span><span class="nf">requestItems</span><span class="p">();</span>
</pre></table></code></div></div><h2 id="inversifyjs">InversifyJS</h2><p>InversifyJS 一个特性是可以利用 lazyInject 来实现无需把依赖放入 constructor 参数中，直接注入为类属性。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nc">Events</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">lazy_inject</span><span class="p">(</span><span class="nx">BINDING</span><span class="p">.</span><span class="nx">Blink</span><span class="p">)</span> <span class="kr">protected</span> <span class="nx">Blink</span><span class="p">:</span><span class="nx">DI</span><span class="p">.</span><span class="nx">Blink</span><span class="p">;</span>
  <span class="p">@</span><span class="nd">lazy_inject</span><span class="p">(</span><span class="nx">BINDING</span><span class="p">.</span><span class="nx">touch_manager</span><span class="p">)</span> <span class="kr">protected</span> <span class="nx">touch_manager</span><span class="p">:</span><span class="nx">DI</span><span class="p">.</span><span class="nx">TouchManager</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">lazy_inject</span><span class="p">(</span><span class="nx">BINDING</span><span class="p">.</span><span class="nx">WorkspaceSvg</span><span class="p">)</span> <span class="kr">protected</span> <span class="nx">WorkspaceSvg</span><span class="p">:</span><span class="nx">DI</span><span class="p">.</span><span class="nx">WorkspaceSvgClass</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>下面将从 Decorator、Reflect-Metadata 解释 InversifyJS 的实现原理。</p><h1 id="ts-中的-decorator">TS 中的 Decorator</h1><h2 id="四种-decorator">四种 Decorator</h2><p>Decorator 类型的定义：</p><ul><li>ClassDecorator<li>MethodDecorator<li>PropertyDecorator<li>ParameterDecorator</ul><h3 id="__decorate">__decorate</h3><p>当我们使用注解时，TypeScript 编译器就会产生一个 <code class="language-plaintext highlighter-rouge">__decorator</code> 函数。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">__decorate</span> <span class="o">=</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">__decorate</span> <span class="o">||</span>
  <span class="nf">function </span><span class="p">(</span><span class="nx">decorators</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nb">Reflect</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nx">decorate</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">decorate</span><span class="p">(</span><span class="nx">decorators</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">desc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">switch </span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">decorators</span><span class="p">.</span><span class="nf">reduceRight</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return </span><span class="p">(</span><span class="nx">d</span> <span class="o">&amp;&amp;</span> <span class="nf">d</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="o">||</span> <span class="nx">o</span><span class="p">;</span>
        <span class="p">},</span> <span class="nx">target</span><span class="p">);</span>
      <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">decorators</span><span class="p">.</span><span class="nf">reduceRight</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">d</span> <span class="o">&amp;&amp;</span> <span class="nf">d</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">),</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">},</span> <span class="k">void</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">decorators</span><span class="p">.</span><span class="nf">reduceRight</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return </span><span class="p">(</span><span class="nx">d</span> <span class="o">&amp;&amp;</span> <span class="nf">d</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">o</span><span class="p">))</span> <span class="o">||</span> <span class="nx">o</span><span class="p">;</span>
        <span class="p">},</span> <span class="nx">desc</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
</pre></table></code></div></div><h3 id="class-decorator">Class Decorator</h3><h4 id="编译结果">编译结果</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">logClass</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>

  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">name</span> <span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">surname</span> <span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 编译结果：</span>
<span class="c1">// 使用了__decorate 的返回值来覆盖原始构造函数</span>
<span class="c1">// 这就是类装饰器必须返回构造函数的原因</span>
<span class="c1">// 类装饰器接受一个参数 target</span>
<span class="kd">var</span> <span class="nx">Person</span> <span class="o">=</span> <span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">Person</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">surname</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">Person</span> <span class="o">=</span> <span class="nf">__decorate</span><span class="p">(</span>
    <span class="p">[</span><span class="nx">logClass</span><span class="p">],</span>          <span class="c1">// decorators</span>
    <span class="nx">Person</span><span class="p">,</span>              <span class="c1">// target</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nx">Person</span><span class="p">;</span>
<span class="p">})();</span>
</pre></table></code></div></div><h4 id="logclass-实现">logClass 实现</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">logClass</span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 保存对原始构造函数的引用</span>
  <span class="kd">const</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>

  <span class="c1">// 生成类实例的工具函数</span>
  <span class="kd">function</span> <span class="nf">construct</span><span class="p">(</span><span class="kd">constructor</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span><span class="p">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">constructor</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">c</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 新的构造器行为</span>
  <span class="kd">var</span> <span class="nx">f</span><span class="p">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">New: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">original</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">construct</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// 复制原型，因此 instanceof 仍然有效</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">original</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

  <span class="c1">// 返回新构造函数(将覆盖原始构造函数)</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="property-decorator">Property Decorator</h3><h4 id="编译结果-1">编译结果</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">logProperty</span>
  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 编译结果：</span>
<span class="c1">// 属性装饰器只需要 2 个参数（原型和键）</span>
<span class="c1">// 属性装饰器没有返回值</span>
<span class="kd">var</span> <span class="nx">Person</span> <span class="o">=</span> <span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">Person</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">surname</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nf">__decorate</span><span class="p">(</span>
    <span class="p">[</span><span class="nx">logProperty</span><span class="p">],</span>     <span class="c1">// decorators</span>
    <span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>  <span class="c1">// target</span>
    <span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">,</span>            <span class="c1">// key</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nx">Person</span><span class="p">;</span>
<span class="p">})();</span>

</pre></table></code></div></div><h4 id="logproperty-实现">logProperty 实现</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1">//</span>
<span class="kd">function</span> <span class="nf">logProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 属性值</span>
  <span class="kd">var</span> <span class="nx">_val</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

  <span class="c1">// 属性 getter</span>
  <span class="kd">var</span> <span class="nx">getter</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Get: </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2"> =&gt; </span><span class="p">${</span><span class="nx">_val</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">_val</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// 属性 setter</span>
  <span class="kd">var</span> <span class="nx">setter</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Set: </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2"> =&gt; </span><span class="p">${</span><span class="nx">newVal</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">_val</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// 从类原型中删除原始属性</span>
  <span class="c1">// 如果属性被成功删除</span>
  <span class="c1">// Object.defineProperty() 方法用于使用原始属性的名称创建一个新的属性</span>
  <span class="k">if </span><span class="p">(</span><span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// 使用 getter 和 setter 创建新属性</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nf">defineProperty</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">getter</span><span class="p">,</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">setter</span><span class="p">,</span>
      <span class="na">enumerable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">configurable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="method-decorator">Method Decorator</h3><h4 id="编译结果-2">编译结果</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">C</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">logMethod</span>
  <span class="nf">foo</span><span class="p">(</span><span class="nx">n</span><span class="p">:</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 编译结果：</span>
<span class="c1">// 方法装饰器需要 3 个参数（原型，键和属性描述符）</span>
<span class="kd">var</span> <span class="nx">C</span> <span class="o">=</span> <span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nf">C</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="nx">C</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nf">defineProperty</span><span class="p">(</span>
    <span class="nf">__decorate</span><span class="p">(</span>
      <span class="p">[</span><span class="nx">log</span><span class="p">],</span>                                              <span class="c1">// decorators</span>
      <span class="nx">C</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>                                        <span class="c1">// target</span>
      <span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span><span class="p">,</span>                                              <span class="c1">// key</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nf">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// desc</span>
    <span class="p">);</span>
  <span class="k">return</span> <span class="nx">C</span><span class="p">;</span>
<span class="p">})();</span>
</pre></table></code></div></div><h4 id="logmethod-实现">logMethod 实现</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cm">/**
 *
 * @param target 被注解的方法
 * @param key 被注解方法的名字
 * @param value
 * 属性的描述，如果这个属性不存在于对象上则为 undefined
 * 可以通过 Object.getOwnPropertyDescriptor() 函数获得
 */</span>
<span class="kd">function</span> <span class="nf">logMethod</span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">value</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// target === C.prototype</span>
  <span class="c1">// key === "foo"</span>
  <span class="c1">// value === Object.getOwnPropertyDescriptor(C.prototype, "foo")</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nf">value</span><span class="p">(...</span><span class="na">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="p">{</span>
      <span class="c1">// 将 foo 参数列表转换为字符串</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nf">join</span><span class="p">();</span>
      <span class="c1">// 调用 foo() 并获取其返回值</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
      <span class="c1">// 将结果转换为字符串</span>
      <span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="c1">// 在控制台中显示函数调用详细信息</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Call: </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">(</span><span class="p">${</span><span class="nx">a</span><span class="p">}</span><span class="s2">) =&gt; </span><span class="p">${</span><span class="nx">r</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="c1">// 返回调用 foo 的结果</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div><p>foo 注解之后也是正常执行，只是还会额外运行 log 的功能，这些功能是由 log 注解添加的。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">C</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">foo</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span> <span class="c1">//  "Call: foo(23) =&gt; 46"</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="c1">// 46</span>
</pre></table></code></div></div><h3 id="parameter-decorator">Parameter Decorator</h3><h4 id="编译结果-3">编译结果</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>

  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">public</span> <span class="nf">saySomething</span><span class="p">(@</span><span class="nd">logParameter</span> <span class="nx">something</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">something</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 编译后代码</span>
<span class="nb">Object</span><span class="p">.</span><span class="nf">defineProperty</span><span class="p">(</span>
  <span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">saySomething</span><span class="dl">"</span><span class="p">,</span>
  <span class="nf">__decorate</span><span class="p">(</span>
    <span class="c1">// 当 __decorate 调用 __param 时 ，它的返回将不会用于覆盖该 saySomething 方法</span>
    <span class="c1">// 参数装饰器不返回</span>
    <span class="p">[</span><span class="nf">__param</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">logParameter</span><span class="p">)],</span>
    <span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="c1">// 正在装饰的类的原型</span>
    <span class="dl">"</span><span class="s2">saySomething</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// 包含要装饰的参数的方法的名称</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nf">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="dl">"</span><span class="s2">saySomething</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// 要装饰的参数的索引</span>
  <span class="p">),</span>
<span class="p">);</span>
<span class="k">return</span> <span class="nx">Person</span><span class="p">;</span>
</pre></table></code></div></div><h4 id="__paramjs-实现">__param.js 实现</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">// __param 函数由 TypeScript 编译器生成</span>
<span class="c1">// 装饰器包装器 __param 用于在闭包中存储参数的索引</span>
<span class="c1">// 索引只是参数列表中的位置</span>
<span class="kd">var</span> <span class="nx">__param</span> <span class="o">=</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">__param</span> <span class="o">||</span>
  <span class="nf">function </span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">decorator</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 返回装饰器函数(包装器)</span>
    <span class="k">return</span> <span class="nf">function </span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//应用装饰器(忽略返回)</span>
      <span class="nf">decorator</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">};</span>
</pre></table></code></div></div><h4 id="logparameter-实现">logParameter 实现</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">logParameter</span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">index</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">metadataKey</span> <span class="o">=</span> <span class="s2">`log_</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">_parameters`</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="nx">metadataKey</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nx">target</span><span class="p">[</span><span class="nx">metadataKey</span><span class="p">].</span><span class="nf">push</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">target</span><span class="p">[</span><span class="nx">metadataKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">index</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>上面的参数装饰器 metadataKey 向类原型添加了一个新的属性(<code class="language-plaintext highlighter-rouge">metadataKey</code>)。新属性是一个数组，包含要装饰的参数的索引。我们可以将这个新属性视为元数据。</p><p>参数装饰器不应该修改构造函数，方法或属性的行为。<strong>参数装饰器只应用于生成某种元数据</strong>。</p><h2 id="装饰工厂">装饰工厂</h2><p>装饰器工厂是一个可以接受任意数量参数的函数，并且必须返回一种类型的装饰器。</p><h3 id="四种装饰器">四种装饰器</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">logClass</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>

  <span class="p">@</span><span class="nd">logProperty</span>
  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="kr">public</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">logMethod</span>
  <span class="kr">public</span> <span class="nf">saySomething</span><span class="p">(@</span><span class="nd">logParameter</span> <span class="nx">something</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">something</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>上面一段代码应用了所有可用的装饰器（类、方法、属性和参数），如果我们可以在任何地方使用装饰器而不用管类型更好。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">log</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>

  <span class="p">@</span><span class="nd">log</span>
  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="kr">public</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="nf">constructor</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">surname</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">=</span> <span class="nx">surname</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">log</span>
  <span class="kr">public</span> <span class="nf">saySomething</span><span class="p">(@</span><span class="nd">log</span> <span class="nx">something</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">surname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">something</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="装饰器工厂函数">装饰器工厂函数</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">log</span><span class="p">(...</span><span class="nx">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">switch </span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">logClass</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">logProperty</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
      <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">logParameter</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">logMethod</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="nl">default</span><span class="p">:</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Decorators are not valid here!</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="可配置的装饰器">可配置的装饰器</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">logClassWithArgs</span><span class="p">({</span> <span class="na">when</span> <span class="p">:</span> <span class="p">{</span> <span class="na">name</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">remo</span><span class="dl">"</span><span class="p">}</span> <span class="p">})</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">logClassWithArgs</span><span class="p">(</span><span class="nx">filter</span><span class="p">:</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return </span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nb">Object</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 在这里实现类装饰器</span>
    <span class="c1">// 类装饰师将有权访问装饰器参数(筛选器)</span>
    <span class="c1">// 因为它们存储在闭包中</span>
  <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="reflect-metadata">Reflect-Metadata</h1><h2 id="反射">反射</h2><p>我们的 JS 应用程序越来越大，我们开始需要一些工具（IoC）和（运行时类型断言）这样的功能来管理这种日益增加的复杂性。</p><p>强大的反射 API 应该允许我们在运行时检查未知对象并找出有关它的所有内容。我们应该能够找到像这样的东西：</p><ul><li>实例的名称<li>实例的类型<li>哪些接口由实例实现<li>实例属性的名称和类型。<li>实例的构造函数参数的名称和类型</ul><p>在 JS 中，我们可以使用 <code class="language-plaintext highlighter-rouge">Object.getOwnPropertyDescriptor()</code> 或 <code class="language-plaintext highlighter-rouge">Object.keys()</code> 等函数来查找有关实例的一些信息，但我们需要反射来实现更强大的开发工具。</p><h2 id="元数据">元数据</h2><ul><li>装饰器通过反射来获取类属性上面的批注<li>但是 JS 的装饰器更多的是对函数或者属性进行一些操作，比如修改他们的值，代理变量，自动绑定 this 等等功能<li>无法实现通过反射来获取究竟有哪些装饰器添加到这个类/方法上，这时候就需要 <code class="language-plaintext highlighter-rouge">Reflect Metadata</code></ul><h2 id="概念">概念</h2><ul><li>Relfect Metadata，可以通过装饰器来给类添加一些自定义的信息<li>然后通过反射将这些信息提取出来<li>也可以通过反射来添加这些信息</ul><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Reflect</span><span class="p">.</span><span class="nf">metadata</span><span class="p">(</span><span class="dl">'</span><span class="s1">inClass</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">Reflect</span><span class="p">.</span><span class="nf">metadata</span><span class="p">(</span><span class="dl">'</span><span class="s1">inMethod</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span><span class="p">)</span>
  <span class="kr">public</span> <span class="nf">hello</span><span class="p">():</span> <span class="nx">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">'</span><span class="s1">hello world</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="dl">'</span><span class="s1">inClass</span><span class="dl">'</span><span class="p">,</span> <span class="nx">Test</span><span class="p">));</span> <span class="c1">// 'A'</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="dl">'</span><span class="s1">inMethod</span><span class="dl">'</span><span class="p">,</span> <span class="k">new</span> <span class="nc">Test</span><span class="p">(),</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">));</span> <span class="c1">// 'B'</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">Metadata Key {Any}</code>: 元数据的 Key，简写 k。对于一个对象来说，他可以有很多元数据，每一个元数据都对应有一个 Key<ul><li>可以对象上面设置一个叫做 <code class="language-plaintext highlighter-rouge">name</code> 的 Key 用来设置他的名字，用 <code class="language-plaintext highlighter-rouge">created time</code> 的 Key 来表示他创建的时间<li>这个 Key 可以是任意类型, 内部本质就是一个 Map 对象</ul><li><code class="language-plaintext highlighter-rouge">Metadata Value {Any}</code>: 简写 v。元数据的类型，任意类型都行<li><code class="language-plaintext highlighter-rouge">Target {Object}</code>: 简写 o。表示要在这个对象上面添加元数据<li><code class="language-plaintext highlighter-rouge">Property {String|Symbol}</code>: 简写 p。用于设置在那个属性上面添加元数据。不仅仅可以在对象上面添加元数据，甚至还可以在对象的属性上面添加元数据。当给一个对象定义元数据的时候，默认指定了 undefined 作为 Property</ul><h2 id="引入">引入</h2><p>安装库 <code class="language-plaintext highlighter-rouge">reflect-metadata</code>：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="dl">"</span><span class="s2">reflect-metadata</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// 定义对象或属性的元数据</span>
<span class="nb">Reflect</span><span class="p">.</span><span class="nf">defineMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">metadataValue</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="nb">Reflect</span><span class="p">.</span><span class="nf">defineMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">metadataValue</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 检查对象或属性的原型链上是否存在元数据键</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">hasMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">hasMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 检查对象或属性是否存在自己的元数据键</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">hasMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">hasMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 获取对象或属性原型链上元数据键的元数据值</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 获取对象或属性的自己的元数据键的元数据值</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getOwnMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getOwnMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 获取对象或属性原型链上的所有元数据键</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadataKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadataKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 获取对象或属性的所有自己的元数据键</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getOwnMetadataKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getOwnMetadataKeys</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 从对象或属性中删除元数据</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">deleteMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">deleteMetadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">propertyKey</span><span class="p">);</span>

<span class="c1">// 通过装饰器将元数据应用于构造函数</span>
<span class="p">@</span><span class="nd">Reflect</span><span class="p">.</span><span class="nf">metadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">metadataValue</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">C</span> <span class="p">{</span>
  <span class="c1">// 通过装饰器将元数据应用于方法(属性)</span>
  <span class="p">@</span><span class="nd">Reflect</span><span class="p">.</span><span class="nf">metadata</span><span class="p">(</span><span class="nx">metadataKey</span><span class="p">,</span> <span class="nx">metadataValue</span><span class="p">)</span>
  <span class="nf">method</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>在 tsconfig.json 配置：</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"compilerOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"es5"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lib"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"es6"</span><span class="p">,</span><span class="w"> </span><span class="s2">"dom"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"types"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"reflect-metadata"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"commonjs"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"moduleResolution"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"experimentalDecorators"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"emitDecoratorMetadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="用途">用途</h2><h3 id="获取属性类型元数据">获取属性类型元数据</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">logType</span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="dl">"</span><span class="s2">design:type</span><span class="dl">"</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2"> type: </span><span class="p">${</span><span class="nx">t</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Demo</span> <span class="p">{</span>
  <span class="c1">// 应用属性装饰器</span>
  <span class="c1">// 会打印出 attr1 type: String</span>
  <span class="p">@</span><span class="nd">logType</span>
  <span class="kr">public</span> <span class="nx">attr1</span> <span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="获取参数类型元数据">获取参数类型元数据</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">logParamTypes</span><span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">types</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="dl">"</span><span class="s2">design:paramtypes</span><span class="dl">"</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nf">join</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2"> param types: </span><span class="p">${</span><span class="nx">s</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{}</span>
<span class="kr">interface</span> <span class="nx">IFoo</span> <span class="p">{}</span>

<span class="kd">class</span> <span class="nc">Demo</span> <span class="p">{</span>
  <span class="c1">// 应用参数装饰器</span>
  <span class="c1">// 打印出：doSomething param types: String, Number, Foo, Object, Object, Function</span>
  <span class="p">@</span><span class="nd">logParameters</span>
  <span class="nf">doSomething</span><span class="p">(</span>
    <span class="nx">param1</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span>
    <span class="nx">param2</span><span class="p">:</span> <span class="nx">number</span><span class="p">,</span>
    <span class="nx">param3</span><span class="p">:</span> <span class="nx">Foo</span><span class="p">,</span>
    <span class="nx">param4</span><span class="p">:</span> <span class="p">{</span> <span class="nl">test</span><span class="p">:</span> <span class="nx">string</span> <span class="p">},</span>
    <span class="nx">param5</span><span class="p">:</span> <span class="nx">IFoo</span><span class="p">,</span>
    <span class="nx">param6</span><span class="p">:</span> <span class="p">(</span><span class="nx">a</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>
  <span class="p">):</span> <span class="nx">number</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="获取返回类型元数据">获取返回类型元数据</h3><p>我们还可以使用 <code class="language-plaintext highlighter-rouge">"design:returntype"</code> 元数据键获取有关方法返回类型的信息：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="dl">"</span><span class="s2">design:returntype</span><span class="dl">"</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="基本类型序列化规则">基本类型序列化规则</h3><ul><li>number 序列化为 Number<li>string 序列化为 String<li>boolean 序列化为 Boolean<li>any 序列化为 Object<li>void 序列化为 undefined<li>Array 序列化为 Array<li>Tuple 序列化为 Array<li>class 序列化为类构造函数<li>Enum 序列化为 Number<li>如果至少有一个签名，则序列化为 Function<li>否则序列化为 Object（包括接口）</ul><h2 id="实现原理">实现原理</h2><p>所有的元数据都是存在于对象下面的 <code class="language-plaintext highlighter-rouge">[[Metadata]]</code> 属性下面，但是不是通过 <code class="language-plaintext highlighter-rouge">Symbol</code> 实现的：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Reflect</span><span class="p">.</span><span class="nf">metadata</span><span class="p">(</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="p">{}</span>

<span class="nb">Object</span><span class="p">.</span><span class="nf">getOwnPropertySymbols</span><span class="p">(</span><span class="nx">A</span><span class="p">);</span> <span class="c1">// []</span>
</pre></table></code></div></div><p>内部的数据结构：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nb">WeakMap</span> <span class="o">&lt;</span> <span class="nx">any</span><span class="p">,</span>
  <span class="nb">Map</span> <span class="o">&lt;</span> <span class="nx">any</span><span class="p">,</span>
  <span class="nb">Map</span> <span class="o">&lt;</span> <span class="nx">any</span><span class="p">,</span>
  <span class="nx">any</span> <span class="o">&gt;&gt;&gt;</span>
    <span class="c1">// 调用的角度</span>
    <span class="c1">// 先根据对象获取，然后在根据属性，最后根据元数据的 Key 获取最终要的数据</span>
    <span class="nx">weakMap</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="nx">k</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="例子">例子</h2><h3 id="controller-与-get">Controller 与 Get</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// app.js</span>
<span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/test</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">SomeClass</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">Get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/a</span><span class="dl">"</span><span class="p">)</span>
  <span class="nf">someGetMethod</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">"</span><span class="s2">hello world</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">Post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/b</span><span class="dl">"</span><span class="p">)</span>
  <span class="nf">somePostMethod</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">// Controller.js</span>
<span class="kd">const</span> <span class="nx">METHOD_METADATA</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">method</span><span class="dl">'</span><span class="err">；</span>
<span class="kd">const</span> <span class="nx">PATH_METADATA</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="err">；</span>

<span class="kd">const</span> <span class="nx">Controller</span> <span class="o">=</span> <span class="p">(</span><span class="nx">path</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">ClassDecorator</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">target</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">Reflect</span><span class="p">.</span><span class="nf">defineMetadata</span><span class="p">(</span><span class="nx">PATH_METADATA</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">createMappingDecorator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">method</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">path</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">MethodDecorator</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return </span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">Reflect</span><span class="p">.</span><span class="nf">defineMetadata</span><span class="p">(</span><span class="nx">PATH_METADATA</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="nb">Reflect</span><span class="p">.</span><span class="nf">defineMetadata</span><span class="p">(</span><span class="nx">METHOD_METADATA</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">Get</span> <span class="o">=</span> <span class="nf">createMappingDecorator</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">Post</span> <span class="o">=</span> <span class="nf">createMappingDecorator</span><span class="p">(</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">);</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c1">// mapRoute.js</span>
<span class="kd">function</span> <span class="nf">mapRoute</span><span class="p">(</span><span class="nx">instance</span><span class="p">:</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">getPrototypeOf</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>

  <span class="c1">// 筛选出类的 methodName</span>
  <span class="kd">const</span> <span class="nx">methodsNames</span> <span class="o">=</span> <span class="nb">Object</span>
    <span class="p">.</span><span class="nf">getOwnPropertyNames</span><span class="p">(</span><span class="nx">prototype</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nf">isConstructor</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">isFunction</span><span class="p">(</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">item</span><span class="p">]));</span>
  <span class="k">return</span> <span class="nx">methodsNames</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">methodName</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">[</span><span class="nx">methodName</span><span class="p">];</span>

    <span class="c1">// 取出定义的 metadata</span>
    <span class="kd">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="nx">PATH_METADATA</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">method</span> <span class="o">=</span> <span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="nx">METHOD_METADATA</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span><span class="err">；</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">route</span><span class="p">,</span>
      <span class="nx">method</span><span class="p">,</span>
      <span class="nx">fn</span><span class="p">,</span>
      <span class="nx">methodName</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">};</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nb">Reflect</span><span class="p">.</span><span class="nf">getMetadata</span><span class="p">(</span><span class="nx">PATH_METADATA</span><span class="p">,</span> <span class="nx">SomeClass</span><span class="p">);</span> <span class="c1">// '/test'</span>

<span class="nf">mapRoute</span><span class="p">(</span><span class="k">new</span> <span class="nc">SomeClass</span><span class="p">());</span>

<span class="cm">/**
 * [{
 *    route: '/a',
 *    method: 'GET',
 *    fn: someGetMethod() { ... },
 *    methodName: 'someGetMethod'
 *  },{
 *    route: '/b',
 *    method: 'POST',
 *    fn: somePostMethod() { ... },
 *    methodName: 'somePostMethod'
 * }]
 *
 */</span>
</pre></table></code></div></div><h1 id="inversifyjs-1">InversifyJS</h1><h2 id="体系结构概述">体系结构概述</h2><p>InversifyJS 在解析依赖关系之前执行：</p><ul><li>注解（Annotation）<li>规划（Planning）<li>中间件（Middleware）（可选）<li>分解（Resolution）<li>激活（Activation）（可选）</ul><h3 id="注解">注解</h3><p>注释：一种将元数据添加到类声明以供依赖注入或编译指令使用的方法。</p><ul><li>注释阶段读取装饰器生成的元数据，并将其转换为请求类和目标类的一系列实例<li>该请求类和目标类的实例将用于在规划阶段生成解决计划</ul><h3 id="规划">规划</h3><ul><li>我们开始新的解析，这意味着容器将创建新的解析上下文。解析上下文包含对容器的引用和对 Plan 的引用<li>Plan 由 Planner 类的实例生成。该 Plan 包含对上下文的引用和对(根)请求的引用。请求表示将被注入目标的依赖</ul><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">SomeType</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">SomeType</span><span class="dl">"</span><span class="p">);</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="kd">class</span> <span class="nc">FooBar</span> <span class="kr">implements</span> <span class="nx">FooBarInterface</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">foo</span> <span class="p">:</span> <span class="nx">FooInterface</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">bar</span> <span class="p">:</span> <span class="nx">BarInterface</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nf">log</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">foobar</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nf">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="dl">"</span><span class="s2">FooInterface</span><span class="dl">"</span><span class="p">)</span> <span class="nx">foo</span> <span class="p">:</span> <span class="nx">FooInterface</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="dl">"</span><span class="s2">BarInterface</span><span class="dl">"</span><span class="p">)</span> <span class="nx">bar</span> <span class="p">:</span> <span class="nx">BarInterface</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="nx">bar</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">foobar</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">FooBarInterface</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">FooBarInterface</span><span class="dl">"</span><span class="p">);</span>
</pre></table></code></div></div><p>前面的代码片段将生成新的上下文和新的 Plan。该 Plan 将包含一个具有 null target 和两个子 requests 的 RootRequest：</p><ul><li>第一个子 request 表示对 fooInterface 的依赖，其目标是名为 Foo 的构造函数参数<li>第二个子 request 表示对 barInterface 的依赖，其目标是名为 Bar 的构造函数参数</ul><h3 id="中间件">中间件</h3><p>如果配置了一些中间件，它将在分解阶段开始之前执行。中间件可以用来开发一些浏览器扩展，这将允许我们使用一些数据可视化工具来显示解决方案，比如 D3.js。这种工具将帮助开发人员在开发过程中发现问题。</p><h3 id="分解阶段">分解阶段</h3><p>该计划被传递给解析器类的实例。解析器将继续解析请求树中的每个依赖项，从叶开始，以根请求结束。解析过程可以同步或异步执行，这有助于提高性能。</p><h3 id="激活">激活</h3><p>激活在依赖关系解决后进行。就在它被添加到缓存(如果是单例)并被注入之前。可以添加一个事件处理程序，在激活完成之前调用它。这个特性允许开发人员做一些事情，比如注入代理来拦截对该对象的属性或方法的所有调用。</p><h2 id="控制依赖项的范围">控制依赖项的范围</h2><p>有许多可用的绑定：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">BindingToSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nf">to</span><span class="p">(</span><span class="na">constructor</span><span class="p">:</span> <span class="p">{</span> <span class="k">new</span><span class="p">(...</span><span class="na">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]):</span> <span class="nx">T</span> <span class="p">}):</span> <span class="nx">BindingInWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toSelf</span><span class="p">():</span> <span class="nx">BindingInWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toConstantValue</span><span class="p">(</span><span class="na">value</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toDynamicValue</span><span class="p">(</span><span class="na">func</span><span class="p">:</span> <span class="p">(</span><span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toConstructor</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="na">constructor</span><span class="p">:</span> <span class="nx">Newable</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toFactory</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="na">factory</span><span class="p">:</span> <span class="nx">FactoryCreator</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toFunction</span><span class="p">(</span><span class="na">func</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toAutoFactory</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="na">serviceIdentifier</span><span class="p">:</span> <span class="nx">ServiceIdentifier</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span>
  <span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toProvider</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="na">provider</span><span class="p">:</span> <span class="nx">ProviderCreator</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>就作用域的行为方式而言，我们可以将这些类型的绑定分为两个主要组：</p><ul><li>将注入 <code class="language-plaintext highlighter-rouge">object</code><li>讲注入 <code class="language-plaintext highlighter-rouge">function</code></ul><h3 id="object">object</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">BindingToSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nf">to</span><span class="p">(</span><span class="na">constructor</span><span class="p">:</span> <span class="p">{</span> <span class="k">new</span><span class="p">(...</span><span class="na">args</span><span class="p">:</span> <span class="nx">any</span><span class="p">[]):</span> <span class="nx">T</span> <span class="p">}):</span> <span class="nx">BindingInWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toSelf</span><span class="p">():</span> <span class="nx">BindingInWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toConstantValue</span><span class="p">(</span><span class="na">value</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toDynamicValue</span><span class="p">(</span><span class="na">func</span><span class="p">:</span> <span class="p">(</span><span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">BindingInWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>默认情况下使用 <code class="language-plaintext highlighter-rouge">inTransientScope</code>，我们可以选择这种类型绑定的范围，但 <code class="language-plaintext highlighter-rouge">toConstantValue</code> 除外，它将始终使用 <code class="language-plaintext highlighter-rouge">inSingletonScope</code>。</p><p>当我们第一次调用 <code class="language-plaintext highlighter-rouge">container.get</code> 时，我们使用 <code class="language-plaintext highlighter-rouge">to</code>、<code class="language-plaintext highlighter-rouge">toSelf</code> 或 <code class="language-plaintext highlighter-rouge">toDynamicValue</code>，InversifyJS 容器将尝试使用构造函数或动态值工厂生成对象实例或值。如果范围设置为 InSingleTonScope，则缓存该值。第二次我们调用 container.get 来获取相同的资源 ID，如果选择了 inSingletonScope，InversifyJS 将尝试从缓存中获取值。</p><h3 id="function">function</h3><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">BindingToSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">toConstructor</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="na">constructor</span><span class="p">:</span> <span class="nx">Newable</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toFactory</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="na">factory</span><span class="p">:</span> <span class="nx">FactoryCreator</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nf">toFunction</span><span class="p">(</span><span class="na">func</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toAutoFactory</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="na">serviceIdentifier</span><span class="p">:</span> <span class="nx">ServiceIdentifier</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span>
  <span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">toProvider</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="na">provider</span><span class="p">:</span> <span class="nx">ProviderCreator</span><span class="o">&lt;</span><span class="nx">T2</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">BindingWhenOnSyntax</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>我们不能选择这种绑定的范围，因为要注入的值(工厂函数)总是单例的。然而，工厂内部实现可能返回也可能不返回单例。以下绑定将注入一个工厂，该工厂将始终是单例。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span>
  <span class="nx">interfaces</span><span class="p">.</span><span class="nx">Factory</span> <span class="o">&lt;</span>
  <span class="nx">Katana</span> <span class="o">&gt;&gt;</span> <span class="dl">"</span><span class="s2">Factory&lt;Katana&gt;</span><span class="dl">"</span><span class="p">.</span><span class="nx">toAutoFactory</span> <span class="o">&lt;</span>
  <span class="nx">Katana</span> <span class="o">&gt;</span>
  <span class="dl">"</span><span class="s2">Katana</span><span class="dl">"</span><span class="p">;</span>
</pre></table></code></div></div><p>工厂返回的值可能是单一值，也可能不是单一值：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">Katana</span> <span class="o">&gt;</span> <span class="dl">"</span><span class="s2">Katana</span><span class="dl">"</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="nx">Katana</span><span class="p">).</span><span class="nf">inTransientScope</span><span class="p">();</span>
<span class="c1">// or</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">Katana</span> <span class="o">&gt;</span> <span class="dl">"</span><span class="s2">Katana</span><span class="dl">"</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="nx">Katana</span><span class="p">).</span><span class="nf">inSingletonScope</span><span class="p">();</span>
</pre></table></code></div></div><h2 id="容器快照">容器快照</h2><p>声明容器快照是一项帮助您轻松编写单元测试的功能：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">expect</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">chai</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">sinon</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">sinon</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// application container is shared by all unit tests</span>
<span class="k">import</span> <span class="nx">container</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../src/ioc/container</span><span class="dl">"</span><span class="p">;</span>

<span class="nf">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Ninja</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nf">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// create a snapshot so each unit test can modify</span>
    <span class="c1">// it without breaking other unit tests</span>
    <span class="nx">container</span><span class="p">.</span><span class="nf">snapshot</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nf">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Restore to last snapshot so each unit test</span>
    <span class="c1">// takes a clean copy of the application container</span>
    <span class="nx">container</span><span class="p">.</span><span class="nf">restore</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="c1">// each test is executed with a snapshot of the container</span>

  <span class="nf">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">Ninja can fight</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">katanaMock</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">hit</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="dl">"</span><span class="s2">hit with mock</span><span class="dl">"</span><span class="p">;</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="nx">container</span><span class="p">.</span><span class="nf">unbind</span><span class="p">(</span><span class="dl">"</span><span class="s2">Katana</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">Something</span> <span class="o">&gt;</span> <span class="dl">"</span><span class="s2">Katana</span><span class="dl">"</span><span class="p">.</span><span class="nf">toConstantValue</span><span class="p">(</span><span class="nx">katanaMock</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">ninja</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span> <span class="o">&lt;</span> <span class="nx">Ninja</span> <span class="o">&gt;</span> <span class="dl">"</span><span class="s2">Ninja</span><span class="dl">"</span><span class="p">;</span>
    <span class="nf">expect</span><span class="p">(</span><span class="nx">ninja</span><span class="p">.</span><span class="nf">fight</span><span class="p">()).</span><span class="nf">eql</span><span class="p">(</span><span class="dl">"</span><span class="s2">hit with mock</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nf">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">Ninja can sneak</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">shurikenMock</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">throw</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="dl">"</span><span class="s2">hit with mock</span><span class="dl">"</span><span class="p">;</span>
      <span class="p">},</span>
    <span class="p">};</span>

    <span class="nx">container</span><span class="p">.</span><span class="nf">unbind</span><span class="p">(</span><span class="dl">"</span><span class="s2">Shuriken</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">Something</span> <span class="o">&gt;</span> <span class="dl">"</span><span class="s2">Shuriken</span><span class="dl">"</span><span class="p">.</span><span class="nf">toConstantValue</span><span class="p">(</span><span class="nx">shurikenMock</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">ninja</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span> <span class="o">&lt;</span> <span class="nx">Ninja</span> <span class="o">&gt;</span> <span class="dl">"</span><span class="s2">Shuriken</span><span class="dl">"</span><span class="p">;</span>
    <span class="nf">expect</span><span class="p">(</span><span class="nx">ninja</span><span class="p">.</span><span class="nf">sneak</span><span class="p">()).</span><span class="nf">eql</span><span class="p">(</span><span class="dl">"</span><span class="s2">hit with mock</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></table></code></div></div><h2 id="容器的-api">容器的 API</h2><p>https://github.com/inversify/InversifyJS/blob/master/wiki/container_api.md</p><h3 id="container-options">Container Options</h3><h4 id="defaultscope">defaultScope</h4><p>默认范围是 <code class="language-plaintext highlighter-rouge">transient</code>，可以在声明绑定时更改类型的范围：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">Warrior</span> <span class="o">&gt;</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">Warrior</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">).</span><span class="nf">inTransientScope</span><span class="p">();</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">Warrior</span> <span class="o">&gt;</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">Warrior</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">).</span><span class="nf">inSingletonScope</span><span class="p">();</span>
</pre></table></code></div></div><p>使用容器选项更改应用程序级别使用的默认范围：</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Container</span><span class="p">({</span> <span class="na">defaultScope</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Singleton</span><span class="dl">"</span> <span class="p">});</span>
</pre></table></code></div></div><h4 id="autobindinjectable">autoBindInjectable</h4><p>你可以用这个激活 <code class="language-plaintext highlighter-rouge">@injectable()</code> 装饰类的自动绑定:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Container</span><span class="p">({</span> <span class="na">autoBindInjectable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">container</span><span class="p">.</span><span class="nf">isBound</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">);</span> <span class="c1">// returns false</span>
<span class="nx">container</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">);</span> <span class="c1">// returns a Ninja</span>
<span class="nx">container</span><span class="p">.</span><span class="nf">isBound</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">);</span> <span class="c1">// returns true</span>
</pre></table></code></div></div><p>手动定义的绑定优先:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Container</span><span class="p">({</span> <span class="na">autoBindInjectable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">container</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="nx">Samurai</span><span class="p">);</span>
<span class="nx">container</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">Ninja</span><span class="p">);</span> <span class="c1">// returns a Samurai</span>
</pre></table></code></div></div><h3 id="containermerge">Container.merge</h3><p>将两个容器合并为一个。</p><h3 id="containergetnamed">container.getNamed</h3><p>命名绑定。</p><h3 id="containergettagged">container.getTagged</h3><p>标记绑定。</p><h3 id="containergetall">container.getAll</h3><p>获取给定标识符的所有可用绑定。</p><h3 id="containerrebind">container.rebind</h3><p>可以使用 <code class="language-plaintext highlighter-rouge">rebind</code> 方法替换给定 <code class="language-plaintext highlighter-rouge">serviceIdentifier</code> 的所有现有绑定。该函数返回 <code class="language-plaintext highlighter-rouge">BindingTexture</code> 的实例，该实例允许创建替换绑定。</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">someType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">someType</span><span class="dl">"</span><span class="p">,</span>
<span class="p">};</span>

<span class="kd">let</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Container</span><span class="p">();</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">number</span> <span class="o">&gt;</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">someType</span><span class="p">.</span><span class="nf">toConstantValue</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span> <span class="o">&lt;</span> <span class="nx">number</span> <span class="o">&gt;</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">someType</span><span class="p">.</span><span class="nf">toConstantValue</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">values1</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">getAll</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">someType</span><span class="p">);</span>
<span class="nf">expect</span><span class="p">(</span><span class="nx">values1</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nf">expect</span><span class="p">(</span><span class="nx">values1</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="nx">container</span><span class="p">.</span><span class="nx">rebind</span> <span class="o">&lt;</span> <span class="nx">number</span> <span class="o">&gt;</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">someType</span><span class="p">.</span><span class="nf">toConstantValue</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">values2</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">getAll</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">someType</span><span class="p">);</span>
<span class="nf">expect</span><span class="p">(</span><span class="nx">values2</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="nf">expect</span><span class="p">(</span><span class="nx">values2</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="containerresolve">container.resolve</h3><p>Resolve 就像 <code class="language-plaintext highlighter-rouge">container.get&lt;T&gt;(serviceIdentifier: ServiceIdentifier&lt;T&gt;)</code>，但是它允许用户创建一个实例，即使没有声明绑定。</p><p>请注意，它只允许跳过声明依赖关系图中根元素的绑定(组合根)。所有的子依赖项都需要声明绑定。</p><h2 id="类-lazyinject">类 lazyInject</h2><p>https://github.com/inversify/InversifyJS/blob/master/wiki/classes_as_id.md</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="dl">"</span><span class="s2">reflect-metadata</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Container</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">,</span> <span class="nx">inject</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">inversify</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">getDecorators</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">inversify-inject-decorators</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Container</span><span class="p">();</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">lazyInject</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">getDecorators</span><span class="p">(</span><span class="nx">container</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">TYPE</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">Dom</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">Dom</span><span class="dl">"</span><span class="p">),</span>
  <span class="na">DomUi</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">DomUi</span><span class="dl">"</span><span class="p">)</span>
<span class="p">};</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="kd">class</span> <span class="nc">DomUi</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">dom</span><span class="p">:</span> <span class="nx">Dom</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nf">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">Dom</span><span class="p">)</span> <span class="nx">dom</span><span class="p">:</span> <span class="nx">Dom</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">DomUi</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="kd">class</span> <span class="nc">Dom</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="p">@</span><span class="nd">lazyInject</span><span class="p">(</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">DomUi</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">domUi</span><span class="p">:</span> <span class="nx">DomUi</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Dom</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="kd">class</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">dom</span><span class="p">:</span> <span class="nx">Dom</span><span class="p">;</span>
  <span class="nf">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">Dom</span><span class="p">)</span> <span class="nx">dom</span><span class="p">:</span> <span class="nx">Dom</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="o">&lt;</span><span class="nx">Dom</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">Dom</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="nx">Dom</span><span class="p">).</span><span class="nf">inSingletonScope</span><span class="p">();</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="o">&lt;</span><span class="nx">DomUi</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPE</span><span class="p">.</span><span class="nx">DomUi</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="nx">DomUi</span><span class="p">).</span><span class="nf">inSingletonScope</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">resolve</span><span class="p">(</span><span class="nx">Test</span><span class="p">);</span> <span class="c1">// Works!</span>
</pre></table></code></div></div><h2 id="生态系统">生态系统</h2><p>工具：</p><ul><li>inversify-binding-decorators - 允许开发人员使用装饰器声明延迟求值属性注入。<li>inversify-inject-decorators - 允许开发人员使用装饰器声明 InversifyJS 绑定。<li>inversify-express-utils - 用 Express 开发快速应用程序的一些实用程序。<li>inversify-restify-utils - 使用 Restify 开发快速应用程序的一些实用程序。<li>inversify-vanillajs-helpers - 使用 VanillaJS 或 Babel 开发 InversifyJS 应用程序的一些帮助程序。<li>inversify-tracer - 允许开发人员跟踪 InversifyJS 创建的对象方法的工具。<li>inversify-components - InversifyJS 之上的层，使您可以将应用程序拆分为多个组件。<li>inversify-token - InversifyJS 的基于令牌的层，为 TypeScript 中的注入启用强类型安全保证。</ul><p>中间件：</p><ul><li>nversify-logger-middleware - InversifyJS 的控制台记录器中间件。</ul><p>开发工具</p><ul><li>inversify-devtools - 支持浏览器扩展的 Web 应用程序。<li>inversify-chrome-devtools - 一个 chrome 扩展，旨在帮助开发人员使用 InversifyJS。</ul><p>文章参考：</p><ul><li><p><a href="http://es6.ruanyifeng.com/#docs/decorator">阮一峰 ES6 入门 - Decorator</a></p><li><p><a href="https://zhuanlan.zhihu.com/p/20297283">方法装饰器</a></p><li><p><a href="https://zhuanlan.zhihu.com/p/42207655">属性装饰器和类装饰器</a></p><li><p><a href="https://zhuanlan.zhihu.com/p/42217208">参数装饰器和装饰器工厂</a></p><li><p><a href="https://zhuanlan.zhihu.com/p/42220487">类型序列化和元数据反射 API</a></p><li><p><a href="https://www.jianshu.com/p/653bce04db0b">JavaScript Reflect Metadata 详解</a></p><li><p><a href="https://github.com/inversify/InversifyJS/tree/master/wiki">InversifyJS-wiki</a></p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/2019/" class="post-tag no-text-decoration" >2019</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/2018/">2018</a> <a class="post-tag" href="/tags/2017/">2017</a> <a class="post-tag" href="/tags/2019/">2019</a> <a class="post-tag" href="/tags/2020/">2020</a> <a class="post-tag" href="/tags/2021/">2021</a> <a class="post-tag" href="/tags/2016/">2016</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Svg-filter/"><div class="card-body"> <span class="timeago small" > Apr 28, 2019 <i class="unloaded">2019-04-28T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Svg-filter</h3><div class="text-muted small"><p> filter 的原理与参数 如何实现一个积木拖起后的加边框加阴影效果 filter 原理与参数 原理 使用了 filter 的 svg们不会将图案直接渲染为最终图形，会渲染图案的像素到临时位图中 由 filter 指定的操作会被应用到该临时区域，其结果会被渲染为最终图形 filter 标记之间就是执行我们想要操作的滤镜基元，每个基元有一个或多个输入，但只有...</p></div></div></a></div><div class="card"> <a href="/posts/Sequelize-cheat-sheet/"><div class="card-body"> <span class="timeago small" > Jul 7, 2019 <i class="unloaded">2019-07-07T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Sequelize-cheat-sheet</h3><div class="text-muted small"><p> 最近需要用到 Mysql 来存一些前端 FusionData（前端定义的数据，存成字符串，自己 parse 后理解），选型就是 Sequelize 这个 Node.js ORM（对象关系映射） 文档：http://docs.sequelizejs.com/ 安装 1 2 yarn add sequelize yarn add mysql2 数据库连接 1 2 3 4 5 6 7 ...</p></div></div></a></div><div class="card"> <a href="/posts/%E5%9F%BA%E9%87%91%E5%AE%9A%E6%8A%95%E6%96%B9%E6%A1%88/"><div class="card-body"> <span class="timeago small" > Aug 18, 2019 <i class="unloaded">2019-08-18T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>基金定投方案</h3><div class="text-muted small"><p> 实践一下基金定投的方案 参考地址：https://zhuanlan.zhihu.com/p/59662099 大盘 只要在大盘 3000 点以下，定投指数基金，三年内一定能赚钱，年化收益 10%-20% 定投原理 长期定投 长期定投，低位买入摊薄了持仓成本，在 ABCD 四天，各买入 1000 元，那么最后的收益将是： 份额 / 成本 * 100% - 1 =（1000 +...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Sentry%E5%89%8D%E7%AB%AF%E9%94%99%E8%AF%AF%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BA/" class="btn btn-outline-primary" prompt="Older"><p>Sentry前端错误监控系统搭建</p></a> <a href="/posts/Cookie%E7%9A%84SameSite%E5%B1%9E%E6%80%A7/" class="btn btn-outline-primary" prompt="Newer"><p>Cookie的SameSite属性</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/ringcrl">chenng</a>.<p class="mb-0"> <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"> 粤ICP备18131461号 </a></p></p></div><div class="footer-right"></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/2018/">2018</a> <a class="post-tag" href="/tags/2017/">2017</a> <a class="post-tag" href="/tags/2019/">2019</a> <a class="post-tag" href="/tags/2020/">2020</a> <a class="post-tag" href="/tags/2021/">2021</a> <a class="post-tag" href="/tags/2016/">2016</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="chenng.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
