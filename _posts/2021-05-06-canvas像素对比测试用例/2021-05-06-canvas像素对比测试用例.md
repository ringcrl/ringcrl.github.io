---
layout: post
title: canvas像素对比测试用例
tags: ['2021']
---

最近在做服务端 canvas-webgl 渲染，探索下怎么通过自动化的方案来保证渲染效果。

## 探索背景

网络上对 Canvas 的渲染测试用例方案归纳有三种：

- 方案一：Node 记录 Canvas 的 API 操作记录，验证执行，例如：jest-mock-canvas
- 方案二：真实浏览器渲染比对，例如 cypress
- 方案三：学习 Three.js 的 e2e 测试用例，使用 puppeteer 进行截图比对

方案一没有太大意义，因为服务端渲染业务逻辑是跟前端完全一致的，影响渲染效果在更底层的 C++ 模块

方案二需要开启浏览器验证，而我们的开发环境全是在容器中进行，没有可视化环境

方案三主要借助 `pixelmatch` 库实现像素级对比，提供了很好的解决思路

截取原图：

![01.jpeg](https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210506173407_3f8f48fcdad57c03a89346b37a4889f7.jpeg)

和原图进行对比：

![02.jpeg](https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210506173427_ab33e9c83a683a7a7bf1d021db5d646a.jpeg)

## 具体实现

因为我们的渲染方案本身就是在服务端操作数据，通过 `gl.readPixels` 来读取像素，天然就是数据操作，因此无需上述 `puppeteer` 截图流程。

```js
// 生成原图或比对图
// const canvasBuffer = app.view.toBuffer();
// await jimp.read(canvasBuffer).bitmap;

const fs = require('fs');
const path = require('path');

const jimp = require('jimp');
const pixelmatch = require('pixelmatch');

const snapshotPic1Path = path.join(__dirname, '../snapshot', 'pixi02-SimHei_0_0.png');
const snapshotPic2Path = path.join(__dirname, '../snapshot', 'pixi02-SimHei_1_0.png');
const diffPicPath = path.join(__dirname, '../snapshot', 'diff.png');

(async () => {
  const expectDiffRate = 0.001;
  const actual = (await jimp.read(fs.readFileSync(snapshotPic1Path))).bitmap;
  const expected = (await jimp.read(fs.readFileSync(snapshotPic2Path))).bitmap;
  const diff = actual;
  const { width, height } = actual;
  const failPixel = pixelmatch(expected.data, actual.data, diff.data, width, height, {
    diffMask: true,
  });

  const failRate = failPixel / (width * height);

  if (failRate >= expectDiffRate) {
    (await jimp.read(diff)).scale(1).quality(100).write(diffPicPath);
    console.log(`create diff image at: ${diffPicPath}`);
  } else {
    console.log('pass');
  }
})();
```

比对效果：

![03.jpg](https://cdn-1257430323.cos.ap-guangzhou.myqcloud.com/assets/imgs/20210506180747_c4a17899045359d04de115bc2d2b4fe7.jpg)

## 参考地址

https://www.zhihu.com/question/280030160/answer/1846544936